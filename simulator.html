<!DOCTYPE html>
<html>
<head>
	<title>sumulator</title>
</head>
<body>

</body>
</html>

<script type="text/javascript">
"use strict";

/*
 *		Readme:
 *
 *		Time - timestamps are in minutes elapsed from midnight, range is [0,1440)
 *
 *
 *
 *
 */




// stub data
var stubExcercise = [{id:1,name:"Crunches",value:20},{id:2,name:"Walking",value:15},{id:3,name:"Running",value:40},{id:4,name:"Sprinting",value:60},{id:5,name:"Squats",value:60},{id:6,name:"Bench press",value:45}];
var stubIngestion = [{id:1,name:"Banana cake, made with sugar",value:47},{id:2,name:"Banana cake, made without sugar",value:55},{id:3,name:"Sponge cake, plain",value:46},{id:4,name:"Vanilla cake made from packet mix with vanilla frosting (Betty Crocker)",value:42},{id:5,name:"Apple, made with sugar",value:44},{id:6,name:"Apple, made without sugar",value:48},{id:7,name:"Waffles, Aunt Jemima (Quaker Oats)",value:76},{id:8,name:"Bagel, white, frozen",value:72},{id:9,name:"Baguette, white, plain",value:95},{id:10,name:"Coarse barley bread, 75-80% kernels, average",value:34},{id:11,name:"Hamburger bun",value:61},{id:12,name:"Kaiser roll",value:73},{id:13,name:"Pumpernickel bread",value:56},{id:14,name:"50% cracked wheat kernel bread",value:58},{id:15,name:"White wheat flour bread",value:71},{id:16,name:"Wonder&#8482; bread, average",value:73},{id:17,name:"Whole wheat bread, average",value:71},{id:18,name:"100% Whole Grain&#8482; bread (Natural Ovens)",value:51},{id:19,name:"Pita bread, white",value:68},{id:20,name:"Corn tortilla",value:52},{id:21,name:"Wheat tortilla",value:30},{id:23,name:"Coca Cola&#174;, average",value:63},{id:24,name:"Fanta&#174;, orange soft drink",value:68},{id:25,name:"Lucozade&#174;, original (sparkling glucose drink)",value:95},{id:26,name:"Apple juice, unsweetened, average",value:44},{id:27,name:"Cranberry juice cocktail (Ocean Spray&#174;)",value:68},{id:28,name:"Gatorade",value:78},{id:29,name:"Orange juice, unsweetened",value:50},{id:30,name:"Tomato juice, canned",value:38},{id:32,name:"All-Bran&#8482;, average",value:55},{id:33,name:"Coco Pops&#8482;, average",value:77},{id:34,name:"Cornflakes&#8482;, average",value:93},{id:35,name:"Cream of Wheat&#8482; (Nabisco)",value:66},{id:36,name:"Cream of Wheat&#8482;, Instant (Nabisco)",value:74},{id:37,name:"Grapenuts&#8482;, average",value:75},{id:38,name:"Muesli, average",value:66},{id:39,name:"Oatmeal, average",value:55},{id:40,name:"Instant oatmeal, average",value:83},{id:41,name:"Puffed wheat, average",value:80},{id:42,name:"Raisin Bran&#8482; (Kellogg's)",value:61},{id:43,name:"Special K&#8482; (Kellogg's)",value:69},{id:45,name:"Pearled barley, average",value:28},{id:46,name:"Sweet corn on the cob, average",value:60},{id:47,name:"Couscous, average",value:65},{id:48,name:"Quinoa",value:53},{id:49,name:"White rice, average",value:89},{id:50,name:"Quick cooking white basmati",value:67},{id:51,name:"Brown rice, average",value:50},{id:52,name:"Converted, white rice (Uncle Ben's&#174;)",value:38},{id:53,name:"Whole wheat kernels, average",value:30},{id:54,name:"Bulgur, average",value:48},{id:56,name:"Graham crackers",value:74},{id:57,name:"Vanilla wafers",value:77},{id:58,name:"Shortbread",value:64},{id:59,name:"Rice cakes, average",value:82},{id:60,name:"Rye crisps, average",value:64},{id:61,name:"Soda crackers",value:74},{id:63,name:"Ice cream, regular",value:57},{id:64,name:"Ice cream, premium",value:38},{id:65,name:"Milk, full fat",value:41},{id:66,name:"Milk, skim",value:32},{id:67,name:"Reduced-fat yogurt with fruit, average",value:33},{id:69,name:"Apple, average",value:39},{id:70,name:"Banana, ripe",value:62},{id:71,name:"Dates, dried",value:42},{id:72,name:"Grapefruit",value:25},{id:73,name:"Grapes, average",value:59},{id:74,name:"Orange, average",value:40},{id:75,name:"Peach, average",value:42},{id:76,name:"Peach, canned in light syrup",value:40},{id:77,name:"Pear, average",value:38},{id:78,name:"Pear, canned in pear juice",value:43},{id:79,name:"Prunes, pitted",value:29},{id:80,name:"Raisins",value:64},{id:81,name:"Watermelon",value:72},{id:83,name:"Baked beans, average",value:40},{id:84,name:"Blackeye peas, average",value:33},{id:85,name:"Black beans",value:30},{id:86,name:"Chickpeas, average",value:10},{id:87,name:"Chickpeas, canned in brine",value:38},{id:88,name:"Navy beans, average",value:31},{id:89,name:"Kidney beans, average",value:29},{id:90,name:"Lentils, average",value:29},{id:91,name:"Soy beans, average",value:15},{id:92,name:"Cashews, salted",value:27},{id:93,name:"Peanuts, average",value:7},{id:95,name:"Fettucini, average",value:32},{id:96,name:"Macaroni, average",value:47},{id:97,name:"Macaroni and Cheese (Kraft)",value:64},{id:98,name:"Spaghetti, white, boiled, average",value:46},{id:99,name:"Spaghetti, white, boiled 20 min, average",value:58},{id:100,name:"Spaghetti, wholemeal, boiled, average",value:42},{id:102,name:"Corn chips, plain, salted, average",value:42},{id:103,name:"Fruit Roll-Ups&#174;",value:99},{id:104,name:"M & M's&#174;, peanut",value:33},{id:105,name:"Microwave popcorn, plain, average",value:55},{id:106,name:"Potato chips, average",value:51},{id:107,name:"Pretzels, oven-baked",value:83},{id:108,name:"Snickers Bar&#174;",value:51},{id:111,name:"Carrots, average",value:35},{id:112,name:"Parsnips",value:52},{id:113,name:"Baked russet potato, average",value:111},{id:114,name:"Boiled white potato, average",value:82},{id:115,name:"Instant mashed potato, average",value:87},{id:116,name:"Sweet potato, average",value:70},{id:117,name:"Yam, average",value:54},{id:110,name:"Green peas, average",value:51},{id:119,name:"Hummus (chickpea salad dip)",value:6},{id:120,name:"Chicken nuggets, frozen, reheated in microwave oven 5 min",value:46},{id:121,name:"Pizza, plain baked dough, served with parmesan cheese and tomato sauce",value:80},{id:122,name:"Pizza, Super Supreme (Pizza Hut)",value:36},{id:123,name:"Honey, average",value:61}];


(function () {

	var configs = {
			debug: true,
			tickInterval: 1, // one minute, unit of time lapse for x-axis
			ticksInDay: 24 * 60,
			sugarLevelInit: 80,
			sugarLevelDefault: 80,
			sugarLevelStep: 1,
			glycationLevelInit: 0,
			glycationStep: 1,
			glycationFloor: 150,
			durationIngestion: 120, // minutes
			durationExcercise:  60, // minutes
	};

	var utils = {
		extendsFromSuper: function (base,target) {
			target.prototype   = Object.create(base.prototype);
			target.constructor = base;
		},
		randomInt: function (max,min) {
			// from zero through and exclusive of max
			if (arguments.length===1)
				return Math.floor(Math.random() * max);
			// from min through and exclusive of max
			else if (arguments.length===2)
				return Math.floor(Math.random() * (max-min)) + min;
		},
		randomTime: function () {
			return utils.randomInt(configs.ticksInDay);
		},
		randomActivity: function (activity) {
			var types = {
				excercise : {subClass:ActivityExcercise,stub:'stubExcercise'},
				ingestion : {subClass:ActivityIngestion,stub:'stubIngestion'},
			};
			var items = window[types[activity].stub];
			var item = items[utils.randomInt(items.length)];
			return new (types[activity].subClass)(item);
		},
		numFormat: function (num, override) {
			// helper to deal with floating arithmetic issues
			var precision = 100000;
			var value = Math.round(num*precision)/precision;
			if (!override && !Number.isInteger(value)) 
			{
				var tmp = Math.round(value);
				if (utils.numFormat(tmp / value, true) === 1) value = tmp;
			}
			return value;
		},
		getLast: function () {
			// returns last element of list
			return this[this.length-1];
		},
		addLast: function (item) {
			// appends new element to a list
			this.push(item);
		},
		newItem: function (time, value) {
			// returns data point item
			return {
				time: time,
				value: utils.numFormat(value)
			};
		}
	};


	// define sumulator

	var Simulator = function () {

		this.activities = []; // list of activities to evaluate
		this.glycation  = []; // list of glycation level variations over day
		this.sugarLevel = []; // list of sugar level variations over day

		// initialize metrics @ 0th time moment
		this.glycation.push( utils.newItem(0, configs.glycationLevelInit));
		this.sugarLevel.push(utils.newItem(0, configs.sugarLevelInit));

		this.run = function () {
			this.fetchActivities();
			this.processData();
			this.printOutput();
		};

		this.addGlycationEntry = function(timeIndex) {
			var lastItem = utils.getLast.call(this.glycation);
			var value = lastItem.value + configs.glycationStep;
			utils.addLast.call(this.glycation, utils.newItem(timeIndex, value));
		};

		this.newSugarLevel = function (timeIndex, value, givenLastItem) {
			var lastItem = givenLastItem || utils.getLast.call(this.sugarLevel);
			var newValue = givenLastItem ? value : lastItem.value + value;
			utils.addLast.call(this.sugarLevel, utils.newItem(timeIndex, newValue));
			if (newValue > configs.glycationFloor) this.addGlycationEntry(timeIndex);
		};

		this.normalizeSugarLevel = function (timeIndex) {
			var lastItem = utils.getLast.call(this.sugarLevel);
			if (!this.isNormalSugar(lastItem.value)) 
			{
				var newValue = this.getNormalizedSugarLevel(lastItem.value);
				this.newSugarLevel(timeIndex, newValue, lastItem);
			}
		};

		this.isNormalSugar = function (value) {
			// returns true only if sugar is normal
			return !(configs.sugarLevelDefault - value);
		}

		this.getNormalizedSugarLevel = function (value) {

			var diff = configs.sugarLevelDefault - value;
			var newValue = value;

			if (Math.abs(diff) >= configs.sugarLevelStep) 
			{
				if (diff < 0) newValue -= configs.sugarLevelStep;
				else newValue += configs.sugarLevelStep;
			} 
			else newValue = configs.sugarLevelDefault;

			return newValue;
		};


	}

	// worker functions 

	Simulator.prototype.fetchActivities = function () {
		// for now just fetch 2 random activities

		this.activities.push(utils.randomActivity.call(this,'excercise'));
		this.activities.push(utils.randomActivity.call(this,'excercise'));
		this.activities.push(utils.randomActivity.call(this,'ingestion'));
		this.activities.push(utils.randomActivity.call(this,'ingestion'));
		this.activities.push(utils.randomActivity.call(this,'ingestion'));
		this.activities.push(utils.randomActivity.call(this,'ingestion'));
		this.activities.push(utils.randomActivity.call(this,'ingestion'));

	};

	Simulator.prototype.processData = function () {

		// points = helper list, hold cumulative deviation values for all activity data points, point index is time
		var points = []; 
		var firstIndex = Infinity; // helper to keep track of the start earliest scheduled activity

		// fill in helper data points
		this.activities.forEach(function (activity) {

			var i = activity.time;
			var max = i + activity.duration;
			var magnitude = activity.value / activity.duration; // step deviation value

			if (activity.addition===false) magnitude = -magnitude; // sign adjustment

			if (i < firstIndex) firstIndex = i;

			for ( ; i<max; i++) 
			{
				if (points[i]===undefined) points[i] = magnitude // new data point
				else points[i] += magnitude; // override of existing data point
			}
		});

		// now simple brute force to get the job done

		var i = firstIndex; // this is the start time of the earliest available activity point
		var max = configs.ticksInDay; // upper time bound for time in day

		for (; i<max; i++) 
		{
			// if activity exists at this time tick
			if (points[i]!==undefined) this.newSugarLevel(i, points[i]);
			// otherwise handle normalization of sugar level towards configs.sugarLevelDefault
			else this.normalizeSugarLevel(i);
		}

		if (configs.debug) 
		{
			console.log("firstIndex: " + firstIndex);
			console.log("points:", points);
		}

	};

	Simulator.prototype.printOutput = function () {
		// print out data sets
		// or/and use some charting lib

		if (configs.debug) 
		{
			console.log("activities:", this.activities);
			console.log("sugarLevel:", this.sugarLevel);
			console.log("glycation:",  this.glycation);
		}
	};


	// define activities

	var Activity = function (info, time) {
		this.name  = info.name;
		this.value = info.value; // glycemic index value
		this.time  = time || utils.randomTime(configs.ticksInDay);  // start time
	};

	var ActivityIngestion = function () {
		Activity.apply(this,arguments);
		this.duration = configs.durationIngestion;
		this.addition = true;
	};
	utils.extendsFromSuper(Activity,ActivityIngestion);

	var ActivityExcercise = function () {
		Activity.apply(this,arguments);
		this.duration = configs.durationExcercise;
		this.addition = false;
	};
	utils.extendsFromSuper(Activity,ActivityExcercise);


	return {
		init: function () {
			return new Simulator();
		},
	};

})().init().run();


</script>
